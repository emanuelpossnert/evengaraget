{
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [{"mode": "everyMinute"}]
        },
        "filters": {
          "includeSpamTrash": false,
          "labelIds": ["INBOX"]
        }
      },
      "name": "Gmail Trigger",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "n1",
      "credentials": {
        "gmailOAuth2": {
          "id": "30lZheVCEHLNKsYy",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const gmailData = $input.first().json;\nconst emailMatch = gmailData.From.match(/<(.+?)>/) || gmailData.From.match(/([^\\s@]+@[^\\s@]+\\.[^\\s@]+)/);\nconst name = gmailData.From.split('<')[0].trim() || 'Kund';\nconst customerEmail = emailMatch ? emailMatch[1] : gmailData.From.trim();\nconsole.log('ðŸ“§ Email from CUSTOMER:', customerEmail);\nreturn [{json: {\n  thread_id: gmailData.threadId,\n  message_id: gmailData.id,\n  from: gmailData.From,\n  agent_email: gmailData.To,\n  subject: gmailData.Subject,\n  body: gmailData.snippet || '',\n  email_address: customerEmail,\n  name: name\n}}];"
      },
      "name": "Extract Email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "n2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1yiEYoKFYx-Y018NiL2sg54lXjq_CjJ1DGtbuVv1cGsw",
          "mode": "list",
          "cachedResultName": "PriceList_template"
        },
        "sheetName": {
          "__rl": true,
          "value": 1874648354,
          "mode": "list",
          "cachedResultName": "PriceList_template"
        }
      },
      "name": "Get Price List",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [680, 300],
      "id": "n3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "rImZoR2a92JfJBoa",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1gX3lQ5Ns5n5-cwqT4fAuU3Spcx86UtUPcUeWPNj2tAQ",
          "mode": "list",
          "cachedResultName": "FAQ_template"
        },
        "sheetName": {
          "__rl": true,
          "value": 1663703534,
          "mode": "list",
          "cachedResultName": "FAQ_template"
        }
      },
      "name": "Get FAQ",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [900, 300],
      "id": "n4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "rImZoR2a92JfJBoa",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const priceList = $('Get Price List').all().map(p => p.json);\nconst faqList = $('Get FAQ').all().map(f => f.json);\nconst email = $('Extract Email').first().json;\nreturn [{json: {...email, priceList, faqList}}];"
      },
      "name": "Merge Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300],
      "id": "n5"
    },
    {
      "parameters": {
        "url": "=https://njiagzdssxoxycxraubf.supabase.co/rest/v1/conversations?gmail_thread_id=eq.{{ $json.thread_id }}&select=id",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "options": {}
      },
      "name": "Find Conversation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1340, 300],
      "id": "n6",
      "credentials": {
        "supabaseApi": {
          "id": "Jn3pqBF4p98BZlo7",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const email = $('Merge Data').first().json;\nconst convResponse = $input.first().json;\nlet conversationId = null;\nif (Array.isArray(convResponse) && convResponse.length > 0) {\n  conversationId = convResponse[0].id;\n  console.log('âœ… Found conversation:', conversationId);\n  return [{json: {...email, conversation_id: conversationId, is_new: false}}];\n}\nconsole.log('ðŸ“ New conversation for:', email.email_address);\nreturn [{json: {...email, conversation_id: null, is_new: true}}];"
      },
      "name": "Check Conversation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300],
      "id": "n7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://njiagzdssxoxycxraubf.supabase.co/rest/v1/conversations",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "gmail_thread_id",
              "value": "={{ $json.thread_id }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "status",
              "value": "active"
            },
            {
              "name": "type",
              "value": "general"
            },
            {
              "name": "assigned_to",
              "value": "ai_support"
            }
          ]
        }
      },
      "name": "Create Conversation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1780, 300],
      "id": "n8",
      "credentials": {
        "supabaseApi": {
          "id": "Jn3pqBF4p98BZlo7",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const email = $('Check Conversation').first().json;\nconst createResp = $input.first().json;\nlet convId = email.conversation_id;\nif (!convId && createResp) {\n  if (Array.isArray(createResp)) {\n    convId = createResp[0]?.id;\n  } else if (createResp.id) {\n    convId = createResp.id;\n  }\n}\nconsole.log('âœ… Conv ID:', convId, 'Customer:', email.email_address);\nreturn [{json: {...email, conversation_id: convId}}];"
      },
      "name": "Get Final Conv ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 300],
      "id": "n9"
    },
    {
      "parameters": {
        "modelId": "gpt-4",
        "messages": {
          "values": [
            {
              "content": "Du Ã¤r EventGaragets kundsupport. REGLER:\n1. Rekommendera ENDAST produkter frÃ¥n listan\n2. Om produkt saknas â†’ sÃ¤g det\n3. ALDRIG uppfinna produkter\n4. Svara personligt\n\nPRODUKTER:\n{{ $json.priceList.map(p => `â€¢ ${p.Name || p.name}: ${p['Price Per Day'] || p.price_per_day} SEK/dag`).join('\\n') }}",
              "role": "system"
            },
            {
              "content": "=FrÃ¥n: {{ $json.name }}\nÃ„mne: {{ $json.subject }}\nMeddelande: {{ $json.body }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.7
        }
      },
      "name": "AI Response",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [2220, 300],
      "id": "n10",
      "credentials": {
        "openAiApi": {
          "id": "erTJVf7Uoi3QApUy",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json;\nlet responseText = '';\nif (aiResponse.message?.content) {\n  responseText = aiResponse.message.content;\n} else if (aiResponse.choices?.[0]?.message?.content) {\n  responseText = aiResponse.choices[0].message.content;\n} else if (typeof aiResponse === 'string') {\n  responseText = aiResponse;\n}\nresponseText = (responseText || '[NO RESPONSE]').toString().trim();\n\nconst emailData = $('Get Final Conv ID').first().json;\nconsole.log('ðŸ“§ SENDING TO CUSTOMER:', emailData.email_address);\n\nif (!emailData.email_address) {\n  throw new Error('CRITICAL: email_address missing!');\n}\n\nreturn [{json: {\n  to: emailData.email_address,\n  subject: `Re: ${emailData.subject}`,\n  html: `<div>${responseText.replace(/\\n/g, '<br/>')}</div>`,\n  responseText,\n  conversation_id: emailData.conversation_id,\n  message_id: emailData.message_id,\n  agent_email: emailData.agent_email,\n  body: emailData.body\n}}];"
      },
      "name": "Format Email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, 300],
      "id": "n11"
    },
    {
      "parameters": {
        "sendTo": "={{$json.to}}",
        "subject": "={{$json.subject}}",
        "message": "={{$json.html}}"
      },
      "name": "Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [2660, 300],
      "id": "n12",
      "credentials": {
        "gmailOAuth2": {
          "id": "30lZheVCEHLNKsYy",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const email = $input.first().json;\nconsole.log('ðŸ’¾ Incoming from:', email.to, '(customer)');\nreturn [{json: {\n  conversation_id: email.conversation_id,\n  gmail_message_id: email.message_id,\n  from_email: email.to,\n  to_email: email.agent_email,\n  subject: email.subject,\n  body: email.body,\n  body_plain: email.body,\n  direction: 'inbound',\n  sender_type: 'customer'\n}}];"
      },
      "name": "Prepare Incoming",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2660, 460],
      "id": "n13"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://njiagzdssxoxycxraubf.supabase.co/rest/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "conversation_id",
              "value": "={{ $json.conversation_id }}"
            },
            {
              "name": "gmail_message_id",
              "value": "={{ $json.gmail_message_id }}"
            },
            {
              "name": "from_email",
              "value": "={{ $json.from_email }}"
            },
            {
              "name": "to_email",
              "value": "={{ $json.to_email }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "body",
              "value": "={{ $json.body }}"
            },
            {
              "name": "body_plain",
              "value": "={{ $json.body_plain }}"
            },
            {
              "name": "direction",
              "value": "={{ $json.direction }}"
            },
            {
              "name": "sender_type",
              "value": "={{ $json.sender_type }}"
            }
          ]
        }
      },
      "name": "Save Incoming",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [2880, 460],
      "id": "n14",
      "credentials": {
        "supabaseApi": {
          "id": "Jn3pqBF4p98BZlo7",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const email = $input.first().json;\nconsole.log('ðŸ’¾ Outgoing to:', email.to, '(customer)');\nreturn [{json: {\n  conversation_id: email.conversation_id,\n  gmail_message_id: email.message_id,\n  from_email: email.agent_email,\n  to_email: email.to,\n  subject: email.subject,\n  body: email.responseText || '',\n  body_plain: email.responseText || '',\n  direction: 'outbound',\n  sender_type: 'ai_support'\n}}];"
      },
      "name": "Prepare Outgoing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2660, 620],
      "id": "n15"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://njiagzdssxoxycxraubf.supabase.co/rest/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "conversation_id",
              "value": "={{ $json.conversation_id }}"
            },
            {
              "name": "gmail_message_id",
              "value": "={{ $json.gmail_message_id }}"
            },
            {
              "name": "from_email",
              "value": "={{ $json.from_email }}"
            },
            {
              "name": "to_email",
              "value": "={{ $json.to_email }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "body",
              "value": "={{ $json.body }}"
            },
            {
              "name": "body_plain",
              "value": "={{ $json.body_plain }}"
            },
            {
              "name": "direction",
              "value": "={{ $json.direction }}"
            },
            {
              "name": "sender_type",
              "value": "={{ $json.sender_type }}"
            }
          ]
        }
      },
      "name": "Save Outgoing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [2880, 620],
      "id": "n16",
      "credentials": {
        "supabaseApi": {
          "id": "Jn3pqBF4p98BZlo7",
          "name": "Supabase account"
        }
      }
    }
  ],
  "connections": {
    "Gmail Trigger": {
      "main": [[{"node": "Extract Email", "type": "main", "index": 0}]]
    },
    "Extract Email": {
      "main": [[{"node": "Get Price List", "type": "main", "index": 0}]]
    },
    "Get Price List": {
      "main": [[{"node": "Get FAQ", "type": "main", "index": 0}]]
    },
    "Get FAQ": {
      "main": [[{"node": "Merge Data", "type": "main", "index": 0}]]
    },
    "Merge Data": {
      "main": [[{"node": "Find Conversation", "type": "main", "index": 0}]]
    },
    "Find Conversation": {
      "main": [[{"node": "Check Conversation", "type": "main", "index": 0}]]
    },
    "Check Conversation": {
      "main": [[{"node": "Create Conversation", "type": "main", "index": 0}]]
    },
    "Create Conversation": {
      "main": [[{"node": "Get Final Conv ID", "type": "main", "index": 0}]]
    },
    "Get Final Conv ID": {
      "main": [[{"node": "AI Response", "type": "main", "index": 0}]]
    },
    "AI Response": {
      "main": [[{"node": "Format Email", "type": "main", "index": 0}]]
    },
    "Format Email": {
      "main": [[
        {"node": "Send Email", "type": "main", "index": 0},
        {"node": "Prepare Incoming", "type": "main", "index": 0},
        {"node": "Prepare Outgoing", "type": "main", "index": 0}
      ]]
    },
    "Prepare Incoming": {
      "main": [[{"node": "Save Incoming", "type": "main", "index": 0}]]
    },
    "Prepare Outgoing": {
      "main": [[{"node": "Save Outgoing", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {},
  "staticData": null,
  "tags": [],
  "triggerCount": 0
}

